# Полная настройка планировщика Windows для MQL5 автоматизации

## Предварительные требования

1. **Git установлен** и настроен для работы с репозиторием
2. **MetaTrader 5** установлен с MetaEditor
3. **PowerShell** доступен (предустановлен в Windows)
4. **Права администратора** для создания задач планировщика

## Шаг 1: Настройка конфигурации

### 1.1 Проверьте файл конфигурации

Файл: `config/build-config.json`

Убедитесь, что все пути правильные:

```json
{
  "RepoPath": "C:\\Users\\Administrator\\AppData\\Roaming\\MetaQuotes\\Terminal\\D0E8209FF7C8CF37AD8BF550E51FF075\\MQL5\\Experts\\Aegis",
  "MetaEditorPath": "C:\\Program Files\\MetaTrader 5\\metaeditor64.exe",
  "EAPath": "C:\\Users\\Administrator\\AppData\\Roaming\\MetaQuotes\\Terminal\\D0E8209FF7C8CF37AD8BF550E51FF075\\MQL5\\Experts\\Aegis\\Aegis_S_Base_RiskSkeleton_v2_Version2.mq5",
  "BackupDir": "C:\\Users\\Administrator\\AppData\\Roaming\\MetaQuotes\\Terminal\\D0E8209FF7C8CF37AD8BF550E51FF075\\MQL5\\Experts\\Aegis\\backup",
  "CreateIssueOnError": true,
  "GitHubRepoSlug": "suhodolov333-stack/AegisAutopilot",
  "Branch": "main"
}
```

### 1.2 Найдите правильные пути для вашей системы

**Как найти Data Folder MT5:**
1. Откройте MetaTrader 5
2. Меню File → Open Data Folder
3. Скопируйте полный путь к папке

**Как найти путь к MetaEditor:**
1. По умолчанию: `C:\Program Files\MetaTrader 5\metaeditor64.exe`
2. Или найдите через поиск Windows: "metaeditor64.exe"

### 1.3 Настройте GitHub Token (опционально)

Для автоматического создания Issues при ошибках:
1. Перейдите в GitHub → Settings → Developer settings → Personal access tokens
2. Создайте новый token с правами `repo`
3. Установите переменную среды Windows:
   ```cmd
   setx GITHUB_TOKEN "your_token_here" /M
   ```

## Шаг 2: Ручное тестирование

### 2.1 Проверьте работу скриптов

Откройте командную строку **от имени администратора** и выполните:

```cmd
cd "путь\к\репозиторию\scripts"
run_pull_build_report.bat
```

Должны увидеть:
- `[INFO] Git fetch/pull...`
- `[INFO] Компиляция через MetaEditor...`
- Создание отчётов в папке `reports/`

## Шаг 3: Настройка планировщика Windows

### Метод 1: Через GUI (рекомендуется)

1. **Откройте планировщик:**
   - Нажмите `Win + R`
   - Введите: `taskschd.msc`
   - Нажмите Enter

2. **Создайте новую задачу:**
   - В правой панели: "Создать задачу..."
   - НЕ используйте "Создать простую задачу"

3. **Вкладка "Общие":**
   - Имя: `AegisAutopilot`
   - Описание: `Автоматическая сборка MQL5 Aegis`
   - Выберите: "Выполнять независимо от регистрации пользователя"
   - Установите флажок: "Выполнять с наивысшими правами"
   - Настройка для: Windows 10

4. **Вкладка "Триггеры":**
   - Нажмите "Создать..."
   - Начать задачу: "По расписанию"
   - Параметры: "Ежедневно"
   - Повторять задачу каждые: `10 минут`
   - в течение: `неопределенно`
   - Установите флажок: "Включено"

5. **Вкладка "Действия":**
   - Нажмите "Создать..."
   - Действие: "Запуск программы"
   - Программа: `cmd`
   - Аргументы: `/c "ПОЛНЫЙ_ПУТЬ_К_РЕПОЗИТОРИЮ\scripts\run_pull_build_report.bat"`
   - Рабочая папка: `ПОЛНЫЙ_ПУТЬ_К_РЕПОЗИТОРИЮ\scripts`

6. **Вкладка "Условия":**
   - Снимите флажок: "Запускать задачу только при питании от электросети"
   - Снимите флажок: "Останавливать выполнение при переходе на питание от батарей"

7. **Вкладка "Параметры":**
   - Установите флажок: "Разрешить выполнение задачи по требованию"
   - Установите флажок: "Запускать новый экземпляр параллельно" → выберите "Не запускать новый экземпляр"

8. **Сохраните задачу**

### Метод 2: Через XML импорт

1. Отредактируйте файл `AutoBuildAegis_Version2.xml`:
   ```xml
   <Arguments>/c "C:\ПОЛНЫЙ_ПУТЬ_К_РЕПОЗИТОРИЮ\scripts\run_pull_build_report.bat"</Arguments>
   <WorkingDirectory>C:\ПОЛНЫЙ_ПУТЬ_К_РЕПОЗИТОРИЮ\scripts</WorkingDirectory>
   ```

2. Импортируйте задачу:
   ```cmd
   schtasks /create /tn "AegisAutopilot" /xml "путь\к\AutoBuildAegis_Version2.xml"
   ```

### Метод 3: Через командную строку

```cmd
schtasks /create /tn "AegisAutopilot" /tr "cmd /c \"ПОЛНЫЙ_ПУТЬ\scripts\run_pull_build_report.bat\"" /sc minute /mo 10 /ru SYSTEM /rl HIGHEST /f
```

## Шаг 4: Проверка работы

### 4.1 Тестирование задачи

1. В планировщике найдите задачу "AegisAutopilot"
2. Щелкните правой кнопкой → "Выполнить"
3. Проверьте в журнале выполнения

### 4.2 Мониторинг логов

Проверяйте следующие файлы:
- `build.log` - лог компиляции MetaEditor
- `reports/last_build.md` - последний отчет о сборке
- `reports/build_YYYYMMDD_HHMMSS.md` - архивные отчеты
- Планировщик Windows → История задач

### 4.3 Проверка папки backup

Убедитесь, что создается папка `backup/` с резервными копиями `.ex5` файлов.

## Устранение проблем

### Проблема: "Система не может найти указанный файл"
- Проверьте все пути в `config/build-config.json`
- Убедитесь, что MetaTrader 5 установлен

### Проблема: "Access denied" или права доступа
- Запустите cmd от имени администратора
- Убедитесь, что задача создана с правами SYSTEM или администратора

### Проблема: Git ошибки
- Убедитесь, что Git настроен и может подключаться к GitHub
- Проверьте SSH ключи или HTTPS аутентификацию

### Проблема: MetaEditor не компилирует
- Проверьте путь к `metaeditor64.exe`
- Убедитесь, что файл `.mq5` существует и доступен для чтения

## Результат

После успешной настройки система будет:
1. Каждые 10 минут выполнять `git pull`
2. Создавать backup старых `.ex5` файлов
3. Компилировать MQL5 код через MetaEditor
4. Генерировать отчеты в папке `reports/`
5. При ошибках создавать Issues в GitHub (при наличии токена)

Все логи и отчеты сохраняются для анализа и отладки.