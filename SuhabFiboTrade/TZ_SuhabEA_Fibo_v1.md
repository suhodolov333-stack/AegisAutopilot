# ТЗ: Советник “SuhabEA” (две фибо‑сетки, расчёт из терминала, постановка по клику)

Цель
- Реализовать EA на MQL5, который:
  - Использует две фибо‑сетки: левая (вход/усреднения L1..L4), правая (тейки TP1..TPn).
  - Берёт все исходные данные из терминала и UI‑панели (никаких внешних CSV).
  - По клику «Place All» выполняет dry‑run, показывает расчёты на панели и, после подтверждения, выставляет все ордера согласно сетке и правилам риска.

UI‑панель (обязательно)
- Переключатель GridRole: Left | Right (выбор активной роли для привязки фибо‑объекта).
- Кнопка Bind Fibo: привязать выбранный на графике Fibonacci‑объект к активной роли.
- Поля ввода (inputs):
  - risk_pct (double, %) — доля от баланса на план.
  - leverage (double) — используемое плечо.
  - base_price (double) — базовая цена (используется в формулах SL; по умолчанию — текущая средняя Bid/Ask, если поле пусто).
  - weights[4] (double[4]) — веса распределения риска для L1..L4.
  - SL_MULT (double) — множитель расчёта Stop Loss.
  - margin_limit_pct (double, %) — порог маржинальной проекции.
  - retryCount (int), stopOnError (bool), DryRunDefault (bool).
- Кнопка Place All: запустить расчёт и диалог подтверждения.
- Диалог подтверждения: сводка dry‑run (перечень уровней с entry/sl/tp/lots/risk/marginImpact/статус) + Confirm/Cancel.
- Индикаторы/таблица:
  - По каждому уровню: entry, SL, TP, lots, riskMoney_i, marginImpact_i, статус валидаций.
  - Общие итоги: totalRiskMoney, projectedMarginPct, количество валидных ордеров.

Полноценное построение фибо (ядро)
- Анкоры: две точки A (baseStart) и B (baseEnd), полученные из выбранного пользователем Fibonacci‑объекта (если уровней в объекте недостаточно — вычислить набор уровней программно).
- Нормализация направления:
  - dir = sign(B − A), span = |B − A|.
  - Округление всех рассчитанных уровней к точности символа.
- Наборы уровней:
  - Расширения (extensions) для левой сетки (входы/усреднения):
    - e1618 = A + dir * span * 1.618
    - e2618 = A + dir * span * 2.618
    - e3618 = A + dir * span * 3.618
    - e4236 = A + dir * span * 4.236
    - Массив Left L = [e1618, e2618, e3618, e4236] (L1..L4 по порядку от ближайшего к A).
  - Ретрейс/таргеты (targets) для правой сетки (тейки):
    - t0000 = B
    - t0382 = B + (A − B) * 0.382
    - t0500 = B + (A − B) * 0.500
    - t0618 = B + (A − B) * 0.618
    - t0786 = B + (A − B) * 0.786
    - t0886 = B + (A − B) * 0.886
    - t1618 = B + (A − B) * 1.618
    - Базовый набор Right TP = [t0786, t1618] (минимум 2 уровня). Разрешено расширять до TP3..TPn из списка выше (через настройки панели).
- Привязка:
  - Пользователь выбирает роль (Left/Right) → нажимает Bind Fibo → EA читает A,B и уровни объекта.
  - Если уровни объекта неполны, дополнить программно по формулам выше.
  - Проверить монотонность уровней по направлению dir; при нарушении — ошибка «Invalid Fibo geometry».

Определение направления и знака сделок
- Правило: isLong = mean(TP‑уровней правой сетки) > mean(L‑уровней левой сетки).
- Все дальнейшие вычисления объёмов и SL/TP привязываются к этому isLong.

Распределение риска и расчёт объёма
- totalRiskMoney = (risk_pct / 100) * AccountBalance().
- По уровням входа L1..L4:
  - riskMoney_i = totalRiskMoney * (weights[i] / sum(weights)).
  - entry_i = L[i].
  - sign = (isLong ? +1 : −1).
  - SL_i = base_price − sign * ( |entry_i − base_price| * SL_MULT ).
  - TP для уровня:
    - Если присутствуют TP‑уровни правой сетки, использовать ближайший/соответствующий по порядку (TP1 к L1, TP2 к L2; если TP меньше, оставшиеся TP = среднее всех доступных TP).
    - При необходимости разрешить режим «единого TP» для всех входов — параметр панели.
  - contractSize = SymbolInfoDouble(sym, SYMBOL_TRADE_CONTRACT_SIZE) (>0).
  - priceFactor = SymbolInfoDouble(sym, SYMBOL_TRADE_TICK_VALUE) (если 0 — fallback: SYMBOL_TRADE_TICK_SIZE * contractSize; при недоступности — ошибка).
  - lots_raw = riskMoney_i / ( |entry_i − SL_i| * contractSize * priceFactor ).
  - Привести lots к шагу и диапазону:
    - step = SYMBOL_VOLUME_STEP, minLot = SYMBOL_VOLUME_MIN, maxLot = SYMBOL_VOLUME_MAX.
    - lots = floor(lots_raw / step) * step.
    - Если lots < minLot → статус «too small», ордер не отправлять.

Маржинальная валидация плана
- addMargin_i = entry_i * contractSize * lots / leverage.
- postMargin = AccountInfoDouble(ACCOUNT_MARGIN) + Σ addMargin_i.
- projectedPct = (postMargin / AccountBalance()) * 100.
- Если projectedPct ≥ margin_limit_pct → отклонить весь план с сообщением «margin projection exceeded».

Процедура исполнения
- Только по клику Place All:
  1) Считать входы с панели; проверить привязки Left/Right (Left обязателен; Right: минимум 2 TP уровня).
  2) Построить полный набор уровней по формулам (если в объекте чего-то нет).
  3) Сформировать план: для каждого L‑уровня — entry, SL, TP, lots, riskMoney_i, marginImpact_i.
  4) Выполнить dry‑run: расчёт + валидации, без OrderSend; отобразить сводку.
  5) По Confirm → выполнить live‑размещение:
     - Вызов PlaceOrderSafe (обёртка над CTrade) с retryCount попыток.
     - При stopOnError=true — остановить на первой критической ошибке.
  6) Записать результаты (tickets/errors) в панель и лог.

Логирование и устойчивость
- Логи с префиксом [SUHAB]: ключевые шаги, параметры плана, ошибки.
- Защита от повторных кликов: mutex флаг на время исполнения.
- Обработка NaN/Inf/нулевых дистанций: помечать уровень invalid и исключать из отправки.

Acceptance‑критерии
- Привязка фибо работает для обеих ролей; при отсутствии уровней объект дополняется полноценно.
- Dry‑run формирует таблицу: по каждому уровню есть entry/sl/tp/lots/risk/marginImpact/статус; projectedPct < margin_limit_pct (или понятная ошибка).
- По Confirm ордера создаются, лоты соответствуют формулам и ограничениям символа.
- Панель отражает актуальные статусы (успешно/ошибка) и итоговые тикеты.

Ограничения
- Никаких жёстких числовых хардкодов: все коэффициенты — через inputs панели.
- Без Confirm — никаких реальных OrderSend.
- Если недоступны contractSize/priceFactor/leverage — выдавать человекочитаемую ошибку и не исполнять.

FUTURE_EXTENSIONS
- Соответствие L↔TP по адаптивному правилу (по дистанции/доходности).
- Частичный выход по лестнице TP1→TPn.
- Undo/rollback отмены неисполненных заявок.